function Invoke-PortScan {
    param (
        [string]$targetInput,
        [string]$portsInput
    )

    # Funzione per espandere un intervallo di porte
    function Expand-Ports {
        param ($portsInput)
        $ports = @()
        
        foreach ($item in $portsInput -split ",") {
            if ($item -match "(\d+)-(\d+)") {
                $ports += ($matches[1]..$matches[2])
            } else {
                $ports += [int]$item
            }
        }
        
        return $ports | Sort-Object -Unique
    }

    # Funzione per espandere una subnet
    function Expand-Subnet {
        param ($subnet)

        $ipList = @()
        
        # Verifica se Ã¨ stata fornita una subnet in notazione CIDR
        if ($subnet -match "^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/(\d{1,2})$") {
            $baseIp = [System.Net.IPAddress]::Parse($matches[1])
            $cidr = [int]$matches[2]

            # Calcola la maschera di rete a partire dal CIDR
            $mask = [uint32]((0xFFFFFFFF << (32 - $cidr)) -band 0xFFFFFFFF)

            # Converte l'indirizzo base e la maschera in formato numerico
            $baseIpInt = [BitConverter]::ToUInt32($baseIp.GetAddressBytes().Reverse(), 0)
            $networkIpInt = $baseIpInt -band $mask
            $broadcastIpInt = $networkIpInt -bor (-bnot $mask)

            # Crea la lista di IP, escludendo indirizzo di rete e di broadcast
            for ($i = $networkIpInt + 1; $i -lt $broadcastIpInt; $i++) {
                $currentIpBytes = [BitConverter]::GetBytes([uint32]$i)
                $ipList += [System.Net.IPAddress]::Parse(($currentIpBytes[3..0] -join '.'))
            }
        } else {
            # Singolo IP, nessuna subnet da espandere
            $ipList += $subnet
        }

        return $ipList
    }

    # Espandi gli intervalli di porte e subnet
    $ports = Expand-Ports $portsInput
    $ips = Expand-Subnet $targetInput
    $results = @()

    foreach ($ip in $ips) {
        foreach ($port in $ports) {
            $client = New-Object System.Net.Sockets.TcpClient
            try {
                $client.Connect($ip.ToString(), $port)
                $results += [pscustomobject]@{
                    "Indirizzo IP" = $ip
                    "Porta"        = $port
                    "Stato"        = "Aperta"
                }
            } catch {
                $results += [pscustomobject]@{
                    "Indirizzo IP" = $ip
                    "Porta"        = $port
                    "Stato"        = "Bloccata"
                }
            } finally {
                $client.Close()
            }
        }
    }

    # Mostra i risultati
    $results | Format-Table -AutoSize
}

# Esecuzione automatica per testare
Invoke-PortScan -targetInput "192.168.1.0/24" -portsInput "20-25,80,443"
